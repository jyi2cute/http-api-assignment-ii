<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script>
  const handleResponse = async (response, method) => {
    const content = document.querySelector("#content");
    let status = response.status;
    let obj = {};

    switch(response.status) {
      case 200: 
      content.innerHTML = '<p class>SUCCESS</p>';
      break;
      case 201:
      content.innerHTML = '<p>CREATED</p>';
      break;
      case 204: 
      content.innerHTML = '<p>UPDATED (No Content)</p>';
      return;
      case 400: 
      content.innerHTML = '<p>BAD REQUEST</p>';
      break;
      case 404:
      content.innerHTML = '<p>NOT FOUND</p>';
      break;
      default:
      content.innerHTML = '<p>Unhandled Status Code.</p>';
      break;
    }

    if (method !== 'HEAD') {
      try {
        const obj = await response.json();
        if (obj.message) {
          content.innerHTML += `<p>Message: ${obj.message}</p>`;
        }
        if (obj.users) {
          content.innerHTML += JSON.stringify(obj.users);
        }
      }catch (e) {
        console.error('Error parsing JSON.', e);
        content.innerHTML += '<p>Error: Could not parse response body.</p>';
      }
    }
  };

  const sendPost = async(nameForm) => {
    const url = nameForm.getAttribute('action');
    const nameField = document.querySelector('#nameField');
    const ageField = document.querySelector('#ageField');
    const method = 'POST';

  const postData = {
    name: nameField.value,
    age: ageField.value
  };

  const response = await fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    },
    body: JSON.stringify(postData),
  });
  handleResponse(response, method);
};

const sendRequest = async (userForm) => {
  const url = userForm.querySelector('#urlField').value;
  const method = userForm.querySelector('#methodSelect').value.toUpperCase();
  
  const response = await fetch(url, {
    method: method,
    headers: {
      'Accept': 'application/json'
    },
  });

  handleResponse(response, method);
};

const init = () => {
  const nameForm = document.querySelector('#nameForm');
  const userForm = document.querySelector('#userForm');

  const addUser = (e) => {
    e.preventDefault();
    sendPost(nameForm);
    return false;
  }

  const getUsers = (e) => {
    e.preventDefault();
    sendRequest(userForm);
    return false;
  }

  nameForm.addEventListener('submit', addUser);
  userForm.addEventListener('submit', getUsers);
};

window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3>POST Status Code Tests</h3>
    <form id="nameForm" action="/addUser" method="post">
      <label for="nameField">Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="ageField">Age: </label>
      <input id="ageField" type="number" name="age" min="0" max="100" step="1"/>
      <input type="submit" value="Add User" />
    </form>
    <form id="userForm" action="/getUsers" method="get">
      <select id='urlField'>
        <option value='/getUsers'>/getUsers</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get User" />
    </form>
  </section>
  <section id="content">
  </section>
</body>
</html>
